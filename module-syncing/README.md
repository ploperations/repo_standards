# Sync'ing modules to this repo's standards

This directory contains tooling and instructions on how to apply the standards set forth in the main [readme](../README.md) to the modules we manage.

At this point in time we are utilizing [pdksync](https://github.com/puppetlabs/pdksync) for some things, but that will change.

- [Sync'ing modules to this repo's standards](#syncing-modules-to-this-repos-standards)
  - [Prep work](#prep-work)
  - [Managed modules](#managed-modules)
  - [Basic updates](#basic-updates)
    - [Cloning all modules](#cloning-all-modules)
    - [Syncing templates](#syncing-templates)
    - [Apply settings via PDK](#apply-settings-via-pdk)
    - [Review what changed](#review-what-changed)
    - [Verify nothing broke](#verify-nothing-broke)
    - [Commit changes and generate PRs](#commit-changes-and-generate-prs)
      - [No added or removed GH Actions, no puppet requirements changes](#no-added-or-removed-gh-actions-no-puppet-requirements-changes)
      - [No added or removed GH Actions, puppet requirements changed](#no-added-or-removed-gh-actions-puppet-requirements-changed)
        - [All modules dropped a puppet version (this is more important the a feature label)](#all-modules-dropped-a-puppet-version-this-is-more-important-the-a-feature-label)
        - [All modules added a puppet version](#all-modules-added-a-puppet-version)
        - [Most modules were unchanged with regards to the puppet version](#most-modules-were-unchanged-with-regards-to-the-puppet-version)
      - [GH Actions added or removed](#gh-actions-added-or-removed)
  - [Bulk releases](#bulk-releases)
    - [Cloning all modules](#cloning-all-modules-1)
    - [Update REFERENCE.md](#update-referencemd)
    - [Release prep](#release-prep)
    - [Release changed modules](#release-changed-modules)

## Prep work

Run `bundle install` in this directory

## Managed modules

The tooling here requires that `managed_modules.yml` is kept up to date with the repositories within the `ploperations` GitHub org.

## Basic updates

The high level process goes something like this:

1. get a temporary copy of every managed module
2. sync our template files to each module
3. run / re-run `pdk convert` on each module
4. run `pdk validate` and `pdk test unit` on each module
5. commmit changes to each module
6. open a pull request with any needed lables
7. get code reviews and merges

### Cloning all modules

You can get a copy of each managed module cloned to `./modules_pdksync` by running `bundle exec rake git:clone_managed_modules`.

### Syncing templates

Run `./update-dio-templated-files.sh` to copy over our templated files. Please note that this script will need updating if new templates have been added since the last sync.

### Apply settings via PDK

First, ensure that all modules have the proper puppet version requirements set by running `bundle exec rake 'pdksync:update_requirements[puppet,version_requirement,>= 6.1.0 < 8.0.0]'`

Next, apply the current PDK standards + our customizations from `.sync.yml` by running `./mass-pdk-commands.sh convert --default-template --force`. We use `convert` here instead of `update` so that any new one-time files generated by PDK will also be added. The `--default-template` flag is used so that the `template-url` and `template-ref` keys are updated appropriately when running with an updated version of PDK.

Lastly, apply new linting and syntax recommendations by executing `./mass-pdk-commands.sh validate -a`. The key thing to watch for here is a warning or failure that was not automatically corrected.

### Review what changed

You can get a quick view of all the changes module by module by running `./diff-each-module.sh`

### Verify nothing broke

Now that the settings have all been updated we need to verify tests still pass by running:

- `./mass-pdk-commands.sh validate`
- `./mass-pdk-commands.sh test unit`

If either of these fail, cd into the directory containing the failure and address it there (not in your normal copy of the module). Return to the same directory as this file and rerun the failing command. Rinse and repeat until both finish successfully.

### Commit changes and generate PRs

Run the following to commit all modifications, push them to GitHub, and open pull requests:

```bash
bundle exec rake 'git:create_commit[sync_to_standards, Sync to current standards]'

bundle exec rake git:push
```

#### No added or removed GH Actions, no puppet requirements changes

If you have not added or removed any GitHub actions to any repos then you can run the following to generate pull requests for every module:

```bash
bundle exec rake 'git:create_pr[Sync to current standards, maintenance]'
```

#### No added or removed GH Actions, puppet requirements changed

If you have not added or removed any GitHub actions to any repos but have made changes to the required puppet versions please note that any module that had its puppet version requirements changed will need a label of either `backwards-incompatible` or `feature` instead of `maintenance` based on if a version was dropped or added. Follow the section below that fits best:

##### All modules dropped a puppet version (this is more important the a feature label)

Run the following command, replacing `X`:

```bash
bundle exec rake 'git:create_pr[Dropped Puppet X, sync to current standards, backwards-incompatible]'
```

##### All modules added a puppet version

Run the following command, replacing `X`:

```bash
bundle exec rake 'git:create_pr[Added Puppet X, sync to current standards, feature]'
```

##### Most modules were unchanged with regards to the puppet version

Run the following command:

```bash
bundle exec rake 'git:create_pr[Sync to current standards, maintenance]'
```

After running this command you will need to go to each module on GitHub that did have a change in its puppet requirements and:

- replace the maintenance label
- update the title of the pull request to either `Dropped Puppet X, sync to current standards` or `Added Puppet X, sync to current standards` as needed (be sure to replace the `X`)

#### GH Actions added or removed

If you have added or removed a GitHub action to a repo then you will need to do the following instead of bulk-creating pull requests:

1. ensure you have [Hub](https://hub.github.com) installed
2. cd to the first module repository
3. run the command below to create a pull request based on whcih case fits the module (note that any module that had its puppet version requirements changed will need a label of either `backwards-incompatible` or `feature` instead of `maintenance` based on if a version was dropped or added):
   - no additions or removals: `hub pull-request --push --browse --labels maintenance`. If the version of puppet required changed, please see the last section for how to modify the pull request title hub prompts you for.
   - added or removed actions:
     1. if adding an action, temporarily change it to run on push instead of just on pull requests so that its initial run will be kicked off. Add this change as an additional commit so we can easily remove it later. Skip to step 2 if not adding an action.
     2. run `hub pull-request --push --browse --labels maintenance --draft`. If the version of puppet required changed, please see the last section for how to modify the pull request title hub prompts you for.
     3. wait for the initial CI run to finish
     4. go to the repository setting on GitHub and edit the branch protection rule for main so that it includes only the desired tests (add new ones and/or remove unneeded ones)
     5. if a commit was added in step 1 and then execute `git reset --hard HEAD~1` followed by `git push -f`
     6. if a push was done via step 5, wait for CI to complete again
     7. mark the PR as ready for review on GitHub (aka take it out of draft mode)
4. repeat these steps for each additional module. I suggest working on the modules in alphabetical order to simplify keeping track of which one is next.

## Bulk releases

### Cloning all modules

You can get a copy of each managed module cloned to `./modules_pdksync` by running `bundle exec rake git:clone_managed_modules`.

### Update REFERENCE.md

Run `./mass-run-puppet-strings.sh` and address any instances where it says `undocumented` or `[warn]` as those will cause the release workflow to fail. Rerun the script until it tells you it has finished successfully.

### Release prep

Module version bumping is solely dependant on what has been done since the last release. Thus, this is going to be a slightly more manual process than the previous parts.

First, do a preliminary update to the changelog on all modules so you can see what kinds of PRs have been merged: `./mass-pdk-commands.sh bundle exec rake changelog` Check the output of this command for any errors or unexpected instances of it saying no tags were found.

Once that has run successfully, `cd` to each module's directory and do the following:

1. Inspect the current CHANGELOG.md. You can do this by running `git diff CHANGELOG.md` (if there is no diff, skip the steps below and move on to the next module). While inspecting the diff, keep the following in mind (listed here in precedence order):
   - the "Uncategorized PRs" heading means you need to add a label on GitHub and re-update the changelog.
   - the "Changed" heading being present means a major / "X" version bump is needed. Run `pdk bundle exec rake module:bump:major`
   - the "Added" heading being present means a minor / "Y" version bump is needed. Run `pdk bundle exec rake module:bump:minor`
     - Note that major new features may warrant a major version bump.
   - the "Fixed" heading being present means a patch / "Z" version bump is needed. Run `pdk bundle exec rake module:bump:patch`
2. Once you have done the version bump, run `pdk bundle exec rake changelog` and review the output for errors again.
3. Run `git diff` to verify the finalized changelogs and everything else looks as expected.
4. Run `git switch -c release-prep` to create a branch for your work and to change to it.
5. Run `git add . && git commit -a -m "$(jq .version -r metadata.json) release prep"`
6. Run `hub pull-request --push --browse --labels maintenance` to push your work to GitHub and open a pull request.

Repeat this process for all remaining modules.

### Release changed modules

After release prep pull requests are approved and/or merged you can go to the "Actions" tab in GitHub and kick off the release workflow that will validate everything, tag the repo with the new version, and push a new version to the Puppet Forge. This can also be done via the [GitHub CLI tool](https://cli.github.com) using a process like the one below:

1. `cd` from this directory into the first changed module's directory
2. Run `gh pr status` and check to see what the status is of your pull request.
   - if approved and CI is green: Run `gh pr merge --merge --delete` to merge your module with a merge commit and then delete the branch
   - if merged: move on to the next step
3. Run `gh workflow run release.yml` to kick off the release process
4. `cd` to next changed module and repeat.
5. Once all workflows have been kicked off, return to the first module's directory
6. Run `gh run list --workflow 'Publish Module'` to check the status of the release process
7. `cd` to next changed module and repeat.
